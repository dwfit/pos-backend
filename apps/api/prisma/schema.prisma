generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/**
 * ----------------------------- ENUMS -----------------------------
 */

enum DevicePlatform {
  android
  ios
}

enum OrderStatus {
  PENDING
  ACTIVE
  CLOSED
  VOID
  DECLINED
}

enum OrderType {
  DINE_IN
  TAKE_AWAY
  DELIVERY
  DRIVE_THRU
  B2B
}

enum PosDeviceStatus {
  USED
  NOT_USED
}

enum PosDeviceType {
  CASHIER
  KDS
  NOTIFIER
  DISPLAY
  SUB_CASHIER
}

enum SyncMode {
  push
  pull
  push_pull
}

enum SyncStatus {
  queued
  running
  done
  error
}

enum SyncStep {
  pulled_settings
  applied_settings
  pushed_data
  heartbeat
}

enum DiscountQualification {
  PRODUCT
  ORDER
  ORDER_AND_PRODUCT
}

enum DiscountType {
  FIXED
  PERCENTAGE
}

/**
 * ----------------------------- ROLES -----------------------------
 */

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users           User[]
  rolePermissions RolePermission[]
}

model Permission {
  id       String           @id @default(cuid())
  code     String           @unique // e.g. "pos.discount.predefined.apply"
  label    String // e.g. "Predefined Discounts"
  category String? // e.g. "Order Authorities"
  roles    RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

/**
 * ----------------------------- CORE MODELS -----------------------------
 */

model Branch {
  id                        String      @id @default(cuid())
  code                      String      @unique
  name                      String
  nameLocalized             String?
  reference                 String?
  taxGroup                  String?
  branchTaxRegistrationName String?
  branchTaxNumber           String?
  openingFrom               String?
  openingTo                 String?
  inventoryEndOfDay         String?
  phone                     String?
  address                   String?
  streetName                String?
  buildingNumber            String?
  additionalNumber          String?
  city                      String?
  district                  String?
  postalCode                String?
  crNumber                  String?
  latitude                  String?
  longitude                 String?
  displayApp                Boolean?    @default(false)
  receiptHeader             String?
  receiptFooter             String?
  tags                      BranchTag[]
  tz                        String?     @default("Asia/Riyadh")
  vatNo                     String?
  isActive                  Boolean     @default(true)
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt

  /// Relations
  devices        Device[]
  posDevices     PosDevice[]
  orders         Order[]
  UserBranch     UserBranch[]
  discountLinks  DiscountBranch[]
  promotionLinks PromotionBranch[]
}

model BranchTag {
  id       String @id @default(cuid())
  name     String
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  @@index([name])
}

/**
 * ----------------------------- USERS -----------------------------
 */

model User {
  id                    String  @id @default(cuid())
  name                  String
  email                 String? @unique
  passwordHash          String
  language              String?
  loginPinHash          String?
  displayLocalizedNames Boolean @default(false)

  roleId        String?
  role          Role?          @relation(fields: [roleId], references: [id])
  isActive      Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  userBranches  UserBranch[]
  voidedOrders  Order[]        @relation("OrderVoidedBy")
  refreshTokens RefreshToken[]
}

model RefreshToken {
  id       String  @id @default(cuid())
  token    String  @unique
  userId   String
  user     User    @relation(fields: [userId], references: [id])
  deviceId String? // e.g. "WEB", "POS-ANDROID-1"

  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
}

model UserBranch {
  userId     String
  branchId   String
  assignedAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, branchId])
  @@index([branchId], map: "idx_userbranch_branchId")
  @@index([userId], map: "idx_userbranch_userId")
}

/**
 * ----------------------------- MENU MODELS -----------------------------
 */

model Category {
  id            String             @id @default(cuid())
  name          String
  imageUrl      String?
  imageId       String?
  image         Media?             @relation("CategoryImage", fields: [imageId], references: [id], onDelete: SetNull)
  sort          Int                @default(0)
  isActive      Boolean            @default(true)
  products      Product[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  discountLinks DiscountCategory[]

  @@index([imageId])
}

model Product {
  id         String   @id @default(cuid())
  sku        String   @unique
  name       String
  imageUrl   String?
  imageId    String?
  image      Media?   @relation("ProductImage", fields: [imageId], references: [id], onDelete: SetNull)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  basePrice Decimal @default(0) @db.Decimal(12, 2)
  taxRate   Decimal @default(0.15) @db.Decimal(4, 2)

  taxId Int?
  tax   Tax? @relation(fields: [taxId], references: [id], onDelete: SetNull)

  isActive  Boolean       @default(true)
  sizes     ProductSize[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  productModifiers  ProductModifier[]
  orderItems        OrderItem[]
  discountSizeLinks DiscountProductSize[]

  @@index([categoryId])
  @@index([imageId])
  @@index([taxId])
}

model ProductSize {
  id                String                @id @default(cuid())
  productId         String
  name              String
  code              String?
  price             Decimal               @db.Decimal(10, 2)
  product           Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  discountSizeLinks DiscountProductSize[]
  promotions        PromotionProduct[]
}

/**
 * --------------------- DEVICE & CUSTOMER ---------------------
 */

model Device {
  id                String         @id @default(cuid())
  branchId          String
  platform          DevicePlatform
  activationKeyHash String
  appVersion        String?
  lastSeenAt        DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([branchId], map: "idx_device_branchId")
}

model Customer {
  id          String    @id @default(cuid())
  name        String
  phone       String?   @unique
  email       String?   @unique
  lastOrderAt DateTime?
  totalOrders Int       @default(0)
  totalSpent  Decimal   @default(0) @db.Decimal(12, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  orders      Order[]
}

/**
 * ----------------------------- ORDERS -----------------------------
 */

model Order {
  id            String      @id @default(cuid())
  branchId      String
  branch        Branch      @relation(fields: [branchId], references: [id])
  customerId    String?
  customer      Customer?   @relation(fields: [customerId], references: [id])
  channel       String
  orderType     OrderType   @default(DINE_IN)
  orderNo       String      @unique
  businessDate  DateTime
  status        String      @default("ACTIVE")
  subtotal      Decimal     @db.Decimal(12, 2)
  discountTotal Decimal     @default(0) @db.Decimal(12, 2)
  taxTotal      Decimal     @db.Decimal(12, 2)
  netTotal      Decimal     @db.Decimal(12, 2)
  closedAt      DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  notes         String?
  items         OrderItem[]
  payments      Payment[]

  discountKind  DiscountType?
  discountValue Decimal?      @db.Decimal(12, 2)

  voidedAt   DateTime?
  voidedById String?
  voidedBy   User?     @relation("OrderVoidedBy", fields: [voidedById], references: [id])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  notes     String?
  size      String?
  qty       Int
  unitPrice Decimal @db.Decimal(12, 2)
  tax       Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  modifiers OrderItemModifier[]
}

model OrderItemModifier {
  id             String       @id @default(cuid())
  orderItemId    String
  orderItem      OrderItem    @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierItemId String
  modifierItem   ModifierItem @relation(fields: [modifierItemId], references: [id])
  qty            Int          @default(1)
  price          Decimal      @db.Decimal(10, 2)
  createdAt      DateTime     @default(now())
}

model Payment {
  id              String  @id @default(cuid())
  orderId         String
  paymentMethodId String?
  method          String
  amount          Decimal @db.Decimal(12, 2)
  ref             String?

  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([orderId], map: "idx_payment_orderId")
  @@index([paymentMethodId])
}

/**
 * ----------------------------- MODIFIERS -----------------------------
 */

model ModifierGroup {
  id        String         @id @default(cuid())
  name      String
  min       Int            @default(0)
  max       Int            @default(1)
  isActive  Boolean        @default(true)
  deletedAt DateTime?
  items     ModifierItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  productModifiers ProductModifier[]
}

model ModifierItem {
  id        String        @id @default(cuid())
  groupId   String
  group     ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name      String
  price     Decimal       @db.Decimal(12, 2)
  isActive  Boolean       @default(true)
  deletedAt DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt

  taxId              Int?
  tax                Tax?                @relation(fields: [taxId], references: [id], onDelete: SetNull)
  orderItemModifiers OrderItemModifier[]

  @@index([taxId])
}

model ProductModifier {
  id         String @id @default(cuid())
  productId  String
  modifierId String

  product  Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  modifier ModifierGroup @relation(fields: [modifierId], references: [id], onDelete: Cascade)

  @@unique([productId, modifierId])
  @@index([productId])
  @@index([modifierId])
}

/**
 * ----------------------------- MEDIA -----------------------------
 */

model Media {
  id        String   @id @default(cuid())
  filename  String
  mimeType  String
  size      Int
  path      String
  url       String?
  bytes     Bytes?
  createdAt DateTime @default(now())

  categories Category[] @relation("CategoryImage")
  products   Product[]  @relation("ProductImage")
}

/**
 * ----------------------------- TAXES -----------------------------
 */

model Tax {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(120)
  rate      Decimal  @db.Decimal(5, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items         TaxGroupItem[]
  products      Product[]
  modifierItems ModifierItem[]

  @@unique([name])
}

model TaxGroup {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(120)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items TaxGroupItem[]

  @@unique([name])
}

model TaxGroupItem {
  id      Int @id @default(autoincrement())
  groupId Int
  taxId   Int

  group TaxGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tax   Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([groupId, taxId])
  @@index([groupId])
  @@index([taxId])
}

/**
 * ----------------------------- POS DEVICES -----------------------------
 */

model PosDevice {
  id                        String            @id @default(cuid())
  deviceCode                String            @unique
  name                      String
  reference                 String?
  type                      PosDeviceType
  status                    PosDeviceStatus
  branchId                  String?
  branch                    Branch?           @relation(fields: [branchId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  deviceSetting             DeviceSetting?
  activationCode            String?           @db.VarChar(6)
  activationCodeGeneratedAt DateTime?
  lastSeenAt                DateTime?
  platform                  String?
  appVersion                String?
  syncJobs                  DeviceSyncJob[]
  syncEvents                DeviceSyncEvent[]

  @@index([branchId], map: "idx_posdevice_branchId")
}

model DeviceSetting {
  deviceId  String    @id
  device    PosDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  data      Json      @default("{}")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model DeviceSyncJob {
  id          String     @id @default(cuid())
  deviceId    String
  mode        SyncMode
  status      SyncStatus
  requestedBy String?
  createdAt   DateTime   @default(now())
  startedAt   DateTime?
  finishedAt  DateTime?
  error       String?

  device PosDevice         @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  events DeviceSyncEvent[]

  @@index([deviceId])
  @@index([status, createdAt])
}

model DeviceSyncEvent {
  id        String      @id @default(cuid())
  jobId     String
  deviceId  String
  step      SyncStep?
  status    SyncStatus?
  error     String?
  createdAt DateTime    @default(now())

  job    DeviceSyncJob @relation(fields: [jobId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  device PosDevice     @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([jobId])
  @@index([deviceId, createdAt])
}

/**
 * ----------------------------- PAYMENT TYPES & METHODS -----------------------------
 */

model PaymentType {
  id   String @id @default(cuid())
  name String @unique

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  methods PaymentMethod[]
}

model PaymentMethod {
  id                 String      @id @default(cuid())
  name               String
  nameLocalized      String?
  typeId             String
  type               PaymentType @relation(fields: [typeId], references: [id])
  code               String?
  autoOpenCashDrawer Boolean     @default(false)

  isActive  Boolean   @default(true)
  sortOrder Int       @default(0)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  auditLogs PaymentMethodAudit[]
  payments  Payment[]
}

model PaymentMethodAudit {
  id              String        @id @default(cuid())
  paymentMethodId String
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])

  action    String
  userId    String?
  before    Json?
  after     Json?
  createdAt DateTime @default(now())
}

/**
 * ----------------------------- SCHEDULERS & AGGREGATORS -----------------------------
 */

model PosScheduler {
  id              String  @id @default(cuid())
  name            String
  reference       String  @unique
  intervalMinutes Int
  isActive        Boolean @default(true)
  isDeleted       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String?
  updatedById String?
}

model PosAggregator {
  id        String  @id @default(cuid())
  name      String
  reference String  @unique
  isActive  Boolean @default(true)
  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String?
  updatedById String?
}

/**
 * ----------------------------- DISCOUNTS -----------------------------
 */

model Discount {
  id            String                @id @default(cuid())
  name          String
  nameLocalized String?
  qualification DiscountQualification
  type          DiscountType
  value         Float
  reference     String                @unique
  taxable       Boolean               @default(false)
  isDeleted     Boolean               @default(false)

  maxDiscount      Float?
  minProductPrice  Float?
  orderTypes       String? // e.g. "DINE_IN,TAKE_AWAY"
  applyAllBranches Boolean @default(false)

  branches     DiscountBranch[]
  categories   DiscountCategory[]
  productSizes DiscountProductSize[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiscountBranch {
  discountId String
  branchId   String

  discount Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  branch   Branch   @relation(fields: [branchId], references: [id])

  @@id([discountId, branchId])
}

model DiscountCategory {
  discountId String
  categoryId String

  discount Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])

  @@id([discountId, categoryId])
}

/**
 * Main pivot: which sizes a discount applies to.
 * We store productSizeId (mandatory) + productId (optional helper).
 */
model DiscountProductSize {
  id String @id @default(cuid())

  discount   Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  discountId String

  productSize   ProductSize @relation(fields: [productSizeId], references: [id])
  productSizeId String

  product   Product? @relation(fields: [productId], references: [id])
  productId String?

  @@index([discountId])
  @@index([productSizeId])
}

model PosReceiptSettings {
  id String @id @default(cuid())

  // if you want per-brand or per-company later, add brandId or companyId here

  logoUrl           String?
  printLanguage     String  @default("MAIN_LOCALIZED") // MAIN_LOCALIZED | MAIN_ONLY | LOCALIZED_ONLY
  mainLanguage      String  @default("en") // en, ar, ...
  localizedLanguage String? @default("ar")
  receiptHeader     String?
  receiptFooter     String?
  invoiceTitle      String? @default("Simplified Tax Invoice")

  showOrderNumber            Boolean @default(true)
  showCalories               Boolean @default(false)
  showSubtotal               Boolean @default(true)
  showRounding               Boolean @default(false)
  showCloserUsername         Boolean @default(false)
  showCreatorUsername        Boolean @default(false)
  showCheckNumber            Boolean @default(true)
  hideFreeModifierOptions    Boolean @default(false)
  printCustomerPhoneInPickup Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PosCallCenterSettings {
  id String @id @default(cuid())

  agents               String? // e.g. "CallCenter"
  acceptedPaymentModes Json? // string[]
  inactiveBranches     String? // free text or CSV
  menuGroup            String? // menu group name/id
  inactiveOrderTypes   String? // free text or CSV

  allowDiscounts       Boolean @default(true)
  allowCoupons         Boolean @default(false)
  allowEditingOrders   Boolean @default(false)
  allowVoidingActive   Boolean @default(false)
  allowReadAllCcOrders Boolean @default(true)
  allowReadAllDcOrders Boolean @default(true)
  allowPriceTags       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PosCashierAppSettings {
  id String @id @default(cuid())

  presetTenderedAmounts      String? // e.g. "50,100,200"
  tenderedAmountCurrencies   String? // e.g. "SAR,USD"
  predefinedTipPercentages   String? // e.g. "5,10,15"
  uploadOrdersDelayMinutes   Int     @default(0)
  inactiveUsersLogoutMinutes Int     @default(30)

  returnMode                 String  @default("LIMITED") // LIMITED | NOT_ALLOWED | UNLIMITED
  limitedReturnPeriodMinutes Int? // used when returnMode = LIMITED
  requireOrderTagsForOrders  String? // tag id / text
  roundingMethod             String? @default("NONE")

  enableTips                          Boolean @default(false)
  discountsRequireCustomerInfo        Boolean @default(false)
  voidRequiresCustomerInfo            Boolean @default(false)
  requireTableGuestForDineIn          Boolean @default(false)
  alwaysAskVoidReasons                Boolean @default(false)
  autoSendToKitchenAfterFullPayment   Boolean @default(true)
  autoDataSyncAtStartOfDay            Boolean @default(false)
  autoPrintProductMix                 Boolean @default(true)
  autoPrintTillReports                Boolean @default(false)
  forceInventoryCountBeforeEndOfDay   Boolean @default(false)
  autoCloseKioskOrders                Boolean @default(false)
  preventSellingOutOfStock            Boolean @default(false)
  printPaymentReceiptsForActiveOrders Boolean @default(false)
  singleTillMode                      Boolean @default(false)
  requireCustomerInfoBeforeClosing    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PosDisplayAppSettings {
  id                 String   @id @default(cuid())
  backgroundImageUrl String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model PosKitchenSettings {
  id                        String   @id @default(cuid())
  sortingMethod             String   @default("MENU_CATEGORY")
  showDefaultModifiersOnKds Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model PosInventorySettings {
  id                            String   @id @default(cuid())
  logoUrl                       String?
  header                        String?
  footer                        String?
  restrictToAvailableQuantities Boolean  @default(false)
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt
}

enum PromotionType {
  BASIC
  ADVANCED
}

enum PromotionDiscountType {
  VALUE // fixed value, e.g. 8 SAR
  PERCENT // percentage
}

enum PromotionConditionKind {
  BUYS_QUANTITY
  SPENDS_AMOUNT
}

enum PromotionRewardKind {
  DISCOUNT_ON_ORDER
  DISCOUNT_ON_PRODUCT
  PAY_FIXED_AMOUNT
}

model Promotion {
  id            String  @id @default(cuid())
  name          String
  nameLocalized String?
  isActive      Boolean @default(true)

  startDate     DateTime
  endDate       DateTime
  startTimeMins Int      @default(0)
  endTimeMins   Int      @default(1439)

  daysCsv       String @default("SUN,MON,TUE,WED,THU,FRI,SAT")
  orderTypesCsv String @default("DINE_IN,PICKUP,DELIVERY,DRIVE_THRU")

  priority         Int?
  includeModifiers Boolean @default(false)

  promotionType PromotionType @default(BASIC)

  // BASIC
  basicDiscountType  PromotionDiscountType?
  basicDiscountValue Float?

  // ADVANCED
  conditionKind       PromotionConditionKind?
  conditionQty        Int?
  conditionSpend      Float?
  rewardKind          PromotionRewardKind?
  rewardDiscountType  PromotionDiscountType?
  rewardDiscountValue Float?
  rewardFixedAmount   Float?

  // relations
  branches PromotionBranch[]
  products PromotionProduct[]

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  promotionCustomerTags PromotionCustomerTag[]
}

model PromotionBranch {
  promotionId String
  branchId    String

  promotion Promotion @relation(fields: [promotionId], references: [id])
  branch    Branch    @relation(fields: [branchId], references: [id])

  @@id([promotionId, branchId])
}

model PromotionProduct {
  promotionId   String
  productSizeId String

  promotion   Promotion   @relation(fields: [promotionId], references: [id])
  productSize ProductSize @relation(fields: [productSizeId], references: [id])

  @@id([promotionId, productSizeId])
}

model PromotionCustomerTag {
  promotionId String
  tagId       String

  promotion Promotion @relation(fields: [promotionId], references: [id])

  @@id([promotionId, tagId])
}
